{% extends 'base.html' %}

{% block conteudo %}

    {% if current_user.is_authenticated %}
    <div class="navbar navbar-expand-lg navbar bg-dark">
        <h5 class="d-inline-block mx-3">
            <a  href="/npc/create" class="text-white-50 link-underline link-underline-opacity-0"> Gerador de NPCs</a>
        </h5>
        <h5 class="d-inline-block mx-3">
            <a  href="/npc" class="text-white-50 link-underline link-underline-opacity-0"> NPCs</a>
        </h5>
        <h5 class="d-inline-block mx-3">
            <a  href="/npc/criatura" class="text-white-50 link-underline link-underline-opacity-0"> Criaturas</a>
        </h5>
    </div>
    <br>

    <!--Aqui Começa o NPC -->

    <div class="card shadow p-5 bg-dark text-white no-margin">

  <h1 span contenteditable="true" class="editable" data-field="nome"><strong>{{ npc.ficha['nome'] }}</strong></h1>
    <hr class='hr'>

    <p><i>#{{ npc.id }} <span contenteditable="true" class="editable" data-field="raca">{{ npc.ficha['raca'] }}</span>, <span contenteditable="true" class="editable" data-field="tamanho">{{ npc.ficha['tamanho'] }}</span>, <span contenteditable="true" class="editable" data-field="tendencia">{{ npc.ficha['tendencia'] }}</span></i></p>

    <p><strong>CA:</strong> <span contenteditable="true" class="editable" data-field="ca">{{ npc.ficha['ca'] }}</span> - <strong>Iniciativa:</strong> <span contenteditable="true" class="editable" data-field="iniciativa">{{ npc.ficha['iniciativa'] }}</span></p>
                
    <p>
        <strong>PV:</strong> 
        <span contenteditable="true" class="editable" data-field="pv">{{ npc.ficha['pv'] }}</span> 
        <span contenteditable="true" class="editable" data-field="dadosvida"><i>( {{ npc.ficha['dadosvida'] }} )</i></span> 
    </p>
    
    <p>
        <strong>Línguas:</strong> 
        <span contenteditable="true" class="editable" data-field="linguas">{{ npc.ficha['linguas'] | join(', ') }}</span>
    </p>
    
    <p>
        <strong>Movimento:</strong> 
        <span contenteditable="true" class="editable" data-field="speed">{{ npc.ficha['speed'] }}</span> 
        {% if npc.ficha['voo'] %}
            <strong> Vôo:</strong> 
            <span contenteditable="true" class="editable" data-field="voo">{{ npc.ficha['voo'] }}</span>
        {% endif %}
        {% if npc.ficha['natacao'] %}
            <strong> Natação:</strong> 
            <span contenteditable="true" class="editable" data-field="natacao">{{ npc.ficha['natacao'] }}</span>
        {% endif %}
    </p>
    
    <div class="row">
        <!-- Coluna 1 -->
        <div class="col-md-4">
            <table class="table table-dark table-borderless">
                <thead>
                    <tr>
                        <th></th>
                        <th></th>
                        <th>Mod</th>
                        <th>Save</th> 
                    </tr>
                    <tr>
                        <td><strong>FOR</strong></td>
                        <td>
                            <span contenteditable="true" class="editable" data-field="forca">{{ npc.ficha['atributos']['forca'] }}</span>
                        </td>
                        <td>
                            <span contenteditable="true" class="editable" data-field="bforca">{{ npc.ficha['atributos']['bforca'] }}</span>
                        </td>
                        <td>
                            <span contenteditable="true" class="editable" data-field="save_forca">{{ npc.ficha['atributos']['save_forca'] }}</span>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>INT</strong></td>
                        <td>
                            <span contenteditable="true" class="editable" data-field="inteligência">{{ npc.ficha['atributos']['inteligência'] }}</span>
                        </td>
                        <td>
                            <span contenteditable="true" class="editable" data-field="binteligência">{{ npc.ficha['atributos']['binteligência'] }}</span>
                        </td>
                        <td>
                            <span contenteditable="true" class="editable" data-field="save_inteligencia">{{ npc.ficha['atributos']['save_inteligencia'] }}</span>
                        </td>
                    </tr>
                </thead>
            </table>
        </div>
        
        <!-- Coluna 2 -->
        <div class="col-md-4">
            <table class="table table-dark table-borderless">
                <thead>
                    <tr>
                        <th></th>
                        <th></th>
                        <th>Mod</th>
                        <th>Save</th> 
                    </tr>
                    <tr>
                        <td><strong>DES</strong></td>
                        <td>
                            <span contenteditable="true" class="editable" data-field="destreza">{{ npc.ficha['atributos']['destreza'] }}</span>
                        </td>
                        <td>
                            <span contenteditable="true" class="editable" data-field="bdestreza">{{ npc.ficha['atributos']['bdestreza'] }}</span>
                        </td>
                        <td>
                            <span contenteditable="true" class="editable" data-field="save_destreza">{{ npc.ficha['atributos']['save_destreza'] }}</span>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>SAB</strong></td>
                        <td>
                            <span contenteditable="true" class="editable" data-field="sabedoria">{{ npc.ficha['atributos']['sabedoria'] }}</span>
                        </td>
                        <td>
                            <span contenteditable="true" class="editable" data-field="bsabedoria">{{ npc.ficha['atributos']['bsabedoria'] }}</span>
                        </td>
                        <td>
                            <span contenteditable="true" class="editable" data-field="save_sabedoria">{{ npc.ficha['atributos']['save_sabedoria'] }}</span>
                        </td>
                    </tr>
                </thead>
            </table>
        </div>
        
        <!-- Coluna 3 -->
        <div class="col-md-4">
            <table class="table table-dark table-borderless">
                <thead>
                    <tr>
                        <th></th>
                        <th></th>
                        <th>Mod</th>
                        <th>Save</th> 
                    </tr>
                    <tr>
                        <td><strong>CON</strong></td>
                        <td>
                            <span contenteditable="true" class="editable" data-field="constituição">{{ npc.ficha['atributos']['constituição'] }}</span>
                        </td>
                        <td>
                            <span contenteditable="true" class="editable" data-field="bconstituição">{{ npc.ficha['atributos']['bconstituição'] }}</span>
                        </td>
                        <td>
                            <span contenteditable="true" class="editable" data-field="save_constituicao">{{ npc.ficha['atributos']['save_constituicao'] }}</span>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>CAR</strong></td>
                        <td>
                            <span contenteditable="true" class="editable" data-field="carisma">{{ npc.ficha['atributos']['carisma'] }}</span>
                        </td>
                        <td>
                            <span contenteditable="true" class="editable" data-field="bcarisma">{{ npc.ficha['atributos']['bcarisma'] }}</span>
                        </td>
                        <td>
                            <span contenteditable="true" class="editable" data-field="save_carisma">{{ npc.ficha['atributos']['save_carisma'] }}</span>
                        </td>
                    </tr>
                </thead>
            </table>                        
        </div>
    </div>
            <p>
            {% if npc.ficha['pericias_atuais'] %}                        
                <strong>Perícias:</strong>                        
                {% for pericia in npc.ficha['pericias_atuais'] %}
                    <span contenteditable="true" class="editable" data-field="pericia_nome_{{ loop.index }}">{{ pericia['nome'] }}</span> 
                    <span contenteditable="true" class="editable" data-field="pericia_valor_{{ loop.index }}">{{ pericia['valor'] }}</span>{% if not loop.last %}, {% endif %}
                {% endfor %}
            {% endif %}
            </p>

            <p>
                <strong>Sentidos:</strong> 
                Percepção Passiva 
                <span contenteditable="true" class="editable" data-field="percepcao_passiva">{{ npc.ficha['Percepcão_passiva'] }}</span>

                {% if npc.ficha['darkvision'] %}
                    , Visão no escuro 
                    <span contenteditable="true" class="editable" data-field="darkvision">{{ npc.ficha['darkvision'] }}</span>'
                {% endif %}
            </p>

            <p>
                <strong>ND:</strong> 
                <span contenteditable="true" class="editable" data-field="nd">{{ npc.ficha['nd'] }}</span> 
                <span contenteditable="true" class="editable" data-field="xp">({{ npc.ficha['xp'] }})</span>  - 
                <strong>Proeficiência </strong>+
                <span contenteditable="true" class="editable" data-field="proef">{{ npc.ficha['proef'] }}</span>
            </p>

            {% if npc.ficha['habilidades_atuais'] %}
            <hr>                        
            <h3><strong>Habilidades</strong></h3>
                {% for habilidade in npc.ficha['habilidades_atuais'] %}
                <p> 
                    <strong>
                        <span contenteditable="true" class="editable" data-field="habilidade_nome_{{ loop.index }}">{{ habilidade['nome'] }}</span>
                    </strong> 
                    <span contenteditable="true" class="editable" data-field="habilidade_descricao_{{ loop.index }}">{{ habilidade['descricao'] }}</span>
                </p>
                {% endfor %}
            {% endif %}


            {% if npc.ficha['reacoes_atuais'] %}
            <hr>

            <h3><strong>Reações</strong></h3>
                {% for habilidade in npc.ficha['reacoes_atuais'] %}
                <p>
                    <strong>
                        <span contenteditable="true" class="editable" data-field="reacao_nome_{{ loop.index }}">{{ habilidade['nome'] }}</span>
                    </strong> 
                    <span contenteditable="true" class="editable" data-field="reacao_descricao_{{ loop.index }}">{{ habilidade['descricao'] }}</span>
                </p>
                {% endfor %}
            {% endif %}
            <hr>
            <h3><strong>Ações</strong></h3>

            {% if npc.ficha['acoes_atuais'] %}
                {% for habilidade in npc.ficha['acoes_atuais'] %}
                <p>
                    <strong>
                        <span contenteditable="true" class="editable" data-field="acao_nome_{{ loop.index }}">{{ habilidade['nome'] }}</span>
                    </strong> 
                    <span contenteditable="true" class="editable" data-field="acao_descricao_{{ loop.index }}">{{ habilidade['descricao'] }}</span>
                </p>
                {% endfor %}
            {% endif %}

            {% for ataque in npc.ficha['ataques_atuais'] %}                   
                <p>
                    <strong>
                        <span contenteditable="true" class="editable" data-field="ataque_nome_{{ loop.index }}">{{ ataque['nome'] }}</span>
                    </strong> 
                    +<span contenteditable="true" class="editable" data-field="ataque_bonus_{{ loop.index }}">{{ ataque['bonus'] }}</span> 
                    Ataque <span contenteditable="true" class="editable" data-field="ataque_tipo_{{ loop.index }}">{{ ataque['tipo'] }}</span> 
                    Alcance <span contenteditable="true" class="editable" data-field="ataque_alcance_{{ loop.index }}">{{ ataque['alcance'] }}</span>. 
                    Acerto <span contenteditable="true" class="editable" data-field="ataque_dano_{{ loop.index }}">{{ ataque['dano'] }}</span> 
                    (<span contenteditable="true" class="editable" data-field="ataque_dado_{{ loop.index }}">{{ ataque['dado'] }}</span>) 
                    <span contenteditable="true" class="editable" data-field="ataque_tipodano_{{ loop.index }}">{{ ataque['tipodano'] }}</span> 
                    <span contenteditable="true" class="editable" data-field="ataque_extra_{{ loop.index }}">{{ ataque['extra'] }}</span>
                </p>
            {% endfor %}
      
            {% if npc.ficha['desclendaria'] and npc.ficha['desclendaria'] != [''] and npc.ficha['acoes_lendarias_atuais'] %}
            
            <hr>                        
            
            
            <h3><strong>Ações Lendárias</strong></h3>
                {% for lendarias in npc.ficha['acoes_lendarias_atuais'] %}
                    <p>
                        <strong>
                            <span contenteditable="true" class="editable" data-field="acao_lendaria_nome_{{ loop.index }}">{{ lendarias['nome'] }}</span>
                        </strong> 
                        <span contenteditable="true" class="editable" data-field="acao_lendaria_descricao_{{ loop.index }}">{{ lendarias['descricao'] }}</span>
                    </p>
                {% endfor %}
            {% endif %}

            {% if npc.ficha['informacoes'] %}
            <hr>
            <h3><strong>Informações</strong></h3>
            <p>
                <span contenteditable="true" class="editable" data-field="informacoes">{{ npc.ficha['informacoes'] }}</span>
            </p>                    
            {% endif %}

            {% if npc.ficha['usos'] %}
            <hr>
            <h3><strong>Dicas de Uso</strong></h3>
            <p>
                <span contenteditable="true" class="editable" data-field="usos">{{ npc.ficha['usos'] }}</span>
            </p>                    
            {% endif %}

            <br>
            <br>
            <button id="save-btn" class="btn btn-primary">Salvar</button>
    </div>
    <br>


    {% endif %}

{% endblock %}

<script>
    document.getElementById('save-btn').addEventListener('click', function() {
        const data = {};
        const editables = document.querySelectorAll('.editable');
    
        editables.forEach(el => {
            data[el.getAttribute('data-field')] = el.innerText; // Captura o valor editado
        });
    
        // Envia os dados para o servidor
        fetch(`/edit/${{ npc.id }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data) // Converte o objeto em JSON
        })
        .then(response => {
            if (response.ok) {
                window.location.reload(); // Atualiza a página após salvar
            } else {
                alert('Erro ao salvar.'); // Lida com erro
            }
        })
        .catch(error => {
            console.error('Erro:', error);
        });
    });
    </script>